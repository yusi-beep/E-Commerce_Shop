{% extends 'base.html' %}
{% block content %}
<h1>Количка</h1>

{% if messages %}
  <ul>
    {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

{% if items and items|length %}
  <style>
    .btn{display:inline-block;padding:.7rem 1.2rem;border-radius:.6rem;border:0;background:#0d6efd;color:#fff;text-decoration:none;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn-danger{background:#dc3545}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.9rem 1rem;border-bottom:1px solid rgba(255,255,255,.08)}
    td form{margin:0}
    .qty-input{width:6rem;padding:.4rem .6rem;border-radius:.5rem;border:1px solid rgba(255,255,255,.2);background:transparent;color:inherit}
    .prod{display:flex;gap:.75rem;align-items:center}
    .thumb{width:48px;height:48px;object-fit:cover;border-radius:.35rem;border:1px solid rgba(255,255,255,.15)}
  </style>

  <table>
    <thead>
      <tr>
        <th>Продукт</th>
        <th>Цена</th>
        <th>Количество</th>
        <th>Общо</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for i in items %}
      <tr>
        <td>
          <div class="prod">
            {% comment %}Image will be added later when we get image_url from cart items{% endcomment %}
            <div>
              <a href="{% url 'product_detail' i.slug %}">{{ i.name }}</a>
              {% if i.type == 'variant' and i.size or i.color or i.sku %}
                <div style="font-size:0.85em;color:rgba(255,255,255,0.7);margin-top:0.25rem;">
                  {% if i.sku %}<span>SKU: {{ i.sku }}</span>{% endif %}
                  {% if i.size %}<span>{% if i.sku %} • {% endif %}Размер: {{ i.size }}</span>{% endif %}
                  {% if i.color %}<span>{% if i.size or i.sku %} • {% endif %}Цвят: {{ i.color }}</span>{% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </td>
        <td>{{ i.price }} лв</td>
        <td>
          <form action="{% url 'cart_update' i.cart_item_id %}" method="post" class="qty-form">
            {% csrf_token %}
            <input class="qty-input" type="number" name="qty" value="{{ i.qty }}" min="0" step="1">
          </form>
        </td>
        <td>{{ i.line_total }} лв</td>
        <td>
          <form action="{% url 'cart_remove' i.cart_item_id %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Премахни</button>
          </form>
        </td>
      </tr>
    {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3" style="text-align:right;">Общо:</td>
        <td>{{ total }} лв</td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <p style="margin-top:1rem; display:flex; gap:.5rem;">
    <a href="/" class="btn btn-link">← Продължи пазаруването</a>
    <a href="{% url 'checkout_view' %}" class="btn">Към поръчката</a>
  </p>

  <script>
    // авто-обновяване при промяна на количество
    const debounce = (fn, ms=400) => { let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };
    document.querySelectorAll('.qty-input').forEach(input => {
      const submit = debounce(() => input.form.requestSubmit(), 350);
      input.addEventListener('input', submit);
      input.addEventListener('change', () => input.form.requestSubmit());
    });
  </script>

{% else %}
  <p>Количката е празна.</p>
  <p><a class="btn" href="/">Към продуктите</a></p>
{% endif %}
{% endblock %}

{% extends 'base.html' %}
{% block content %}

<div class="shop-container"><!-- двуколонен layout: sidebar + съдържание -->

  <!-- Sidebar -->
  <button class="sidebar-toggle" onclick="document.getElementById('shopSidebar').toggleAttribute('hidden')">
    Категории ▾
  </button>
  <aside id="shopSidebar" class="sidebar">
    <h2>Категории</h2>
    <ul class="cat-list">
      <!-- Активен „Всички“, когато няма избрана категория -->
      <li><a href="/" class="{% if not request.GET.cat %}active{% endif %}">Всички</a></li>
      {% for c in categories %}
        <li>
          <a href="/?cat={{ c.slug }}"
             class="{% if request.GET.cat == c.slug %}active{% endif %}">
            {{ c.name }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </aside>

  <!-- Main -->
  <main>
    <div class="products-grid">
      {% for p in products %}
        <article class="product-card">
          <a class="product-media" href="{% url 'product_detail' p.slug %}">
            {% if p.discount_percent %}<span class="badge-sale">-{{ p.discount_percent }}%</span>{% endif %}
            {% if p.stock == 0 %}<span class="badge-oos">Изчерпан</span>{% endif %}

            {% if p.image_avif %}
              <picture>
                <source srcset="{{ p.image_avif.url }}" type="image/avif">
                {% if p.image_webp %}<source srcset="{{ p.image_webp.url }}" type="image/webp">{% endif %}
                <img class="img" src="{{ p.image.url }}" alt="{{ p.name }}" loading="lazy" decoding="async">
              </picture>
            {% elif p.image %}
              <img class="img" src="{{ p.image.url }}" alt="{{ p.name }}" loading="lazy" decoding="async">
            {% else %}
              <div class="img" aria-label="No image"></div>
            {% endif %}
          </a>

          <h3 class="product-title">{{ p.name }}</h3>
          <div class="product-meta">В наличност: {{ p.stock }} бр.</div>

          <div class="product-price">
            <span class="now">{{ p.price }}лв.</span>
            {% if p.old_price %}<span class="old">{{ p.old_price }}лв.</span>{% endif %}
          </div>

          <div class="card-actions">
            <a class="btn-view" href="{% url 'product_detail' p.slug %}">Виж</a>
            <form action="{% url 'cart_add' p.id %}" method="post">
              {% csrf_token %}
              <input type="hidden" name="qty" value="1">
              <button class="btn-add" {% if p.stock == 0 %}disabled aria-disabled="true"{% endif %}>Добави</button>
            </form>
          </div>
        </article>
      {% endfor %}
    </div>

    {% if is_paginated %}
      <nav class="pager">
        {% if page_obj.has_previous %}
          <a class="btn-view" href="?{% if request.GET.cat %}cat={{ request.GET.cat }}&{% endif %}page={{ page_obj.previous_page_number }}">← Назад</a>
        {% endif %}
        <span>Стр. {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a class="btn-view" href="?{% if request.GET.cat %}cat={{ request.GET.cat }}&{% endif %}page={{ page_obj.next_page_number }}">Напред →</a>
        {% endif %}
      </nav>
    {% endif %}
  </main>

</div>
{% endblock %}
